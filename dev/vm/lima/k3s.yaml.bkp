minimumLimaVersion: 2.0.0

base: template:_images/ubuntu-lts

cpus: 4
memory: "8GiB"
disk: "40GiB"

mounts:
  - location: "~/Projects/fin/soul/bc/template/dev/vm/k8s"
    mountPoint: /k8s
    writable: true

containerd:
  system: false
  user: false

portForwards:
  - guestPort: 32000
    hostPort: 32000

provision:
  - mode: system
    script: |
      #!/bin/sh
      if [ ! -d /var/lib/rancher/k3s ]; then
          curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server --write-kubeconfig-mode 644" sh -
      fi
      sudo mkdir -p /var/lib/rancher/k3s/storage
      sudo chmod 755 /var/lib/rancher/k3s/storage
      sudo mkdir -p /var/lib/rancher/k3s
      sudo chown -R root:root /var/lib/rancher
      sudo chmod -R 755 /var/lib/rancher
#      curl -fsL https://run.linkerd.io/install | sh
#      #echo 'export PATH="$PATH:$HOME/.linkerd2/bin"' >> ~/.bashrc
#      #source ~/.bashrc
#      mkdir -p ~/.kube
#      sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
#      #sudo chown gui:gui ~/.kube/config
#      sudo chmod 666 ~/.kube/config
#      # linkerd sed change content
#      # change 127.0.0.1 to localhost
#
#      linkerd install --crds | kubectl apply -f -
#      linkerd install-cni | kubectl apply -f -
#      kubectl annotate namespace apps linkerd.io/inject=enabled





probes:
  - script: |
      #!/bin/bash
      set -eux -o pipefail
      if ! timeout 30s bash -c "until test -f /etc/rancher/k3s/k3s.yaml; do sleep 3; done"; then
          echo >&2 "k3s is not running yet"
          exit 1
      fi
    hint: |
      The k3s kubeconfig file has not yet been created.
      Run "limactl shell lima sudo journalctl -u k3s" to check the log.

copyToHost:
  - guest: "/etc/rancher/k3s/k3s.yaml"
    host: "{{.Dir}}/copied-from-guest/kubeconfig.yaml"
    deleteOnStop: true

message: |
  To run kubectl on the host, run:
  export KUBECONFIG="{{.Dir}}/copied-from-guest/kubeconfig.yaml"
  kubectl ...